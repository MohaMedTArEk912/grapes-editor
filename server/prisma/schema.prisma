
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  settings    String   @default("{}") // JSON: ProjectSettings
  rootPath    String?

  pages       Page[]
  blocks      Block[]
  variables   Variable[]
  dataModels  DataModel[]
  apis        ApiEndpoint[]
  logicFlows  LogicFlow[]
  useCases    UseCase[]
  apiRequests ApiRequest[]
}

model Page {
  idRoot       String    @id @default(uuid()) // Internal DB ID usually, but we use string UUIDs
  id           String    @unique // Public ID
  projectId    String
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name         String
  path         String
  isDynamic    Boolean   @default(false)
  meta         String    @default("{}") // JSON
  archived     Boolean   @default(false)

  blocks       Block[]

  @@unique([projectId, path])
}

model Block {
  id           String   @id // Public UUID
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  pageId       String?
  page         Page?    @relation(fields: [pageId], references: [idRoot]) // Relation to Page Internal ID?
  // Wait, Page.id is unique string. We can reference it.
  
  parentId     String?  // ID of parent block
  // Note: We don't enforce foreign key on parentId for flexibility in drag-drop/sync, 
  // or we can use a self-relation. For now, keep it simple string + index.

  blockType    String
  name         String
  
  // JSON Blobs for flexible schema
  properties       String   @default("{}")
  styles           String   @default("{}")
  responsiveStyles String   @default("{}")
  classes          String   @default("[]") // The fix we just made!
  events           String   @default("{}")
  bindings         String   @default("{}")
  
  children     String   @default("[]") // Array of IDs for order
  order        Int      @default(0)
  archived     Boolean  @default(false)
  
  @@index([projectId])
  @@index([pageId])
  @@index([parentId])
}

model Variable {
  id           String   @id @default(uuid())
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name         String
  value        String?  // JSON or string
  type         String
  isSecret     Boolean  @default(false)
}

model DataModel {
  id           String   @id @default(uuid())
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name         String
  schema       String   // JSON: fields, relations
  archived     Boolean  @default(false)
}

model ApiEndpoint {
  id           String   @id @default(uuid())
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  method       String
  path         String
  name         String
  config       String   // JSON: headers, body, params
  logicFlowId  String?
  archived     Boolean  @default(false)
}

model LogicFlow {
  id           String   @id @default(uuid())
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name         String
  trigger      String   // JSON
  nodes        String   // JSON array of nodes
  edges        String   // JSON array of edges (if separate) or embedded in nodes
  archived     Boolean  @default(false)
}

model UseCase {
  id              String   @id @default(uuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name            String
  description     String   @default("")
  actors          String   @default("[]")  // JSON array of role/actor names
  preconditions   String   @default("")
  postconditions  String   @default("")
  steps           String   @default("[]")  // JSON array: [{order, description}]
  priority        String   @default("medium")  // low | medium | high | critical
  status          String   @default("draft")   // draft | active | completed | archived
  category        String   @default("")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  archived        Boolean  @default(false)

  @@index([projectId])
}

model ApiRequest {
  id              String   @id @default(uuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  method          String
  url             String
  headers         String   @default("{}")  // JSON object
  body            String   @default("")
  params          String   @default("{}")  // JSON query params
  responseStatus  Int?
  responseHeaders String   @default("{}")  // JSON
  responseBody    String   @default("")
  duration        Int      @default(0)     // ms
  createdAt       DateTime @default(now())

  @@index([projectId])
}
